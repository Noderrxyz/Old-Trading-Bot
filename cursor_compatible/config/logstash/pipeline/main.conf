input {
  # TCP input for direct log shipping
  tcp {
    port => 5000
    codec => json
  }
  
  # UDP input for GELF formatted logs
  gelf {
    port => 12201
    type => "docker"
  }
  
  # HTTP endpoint for direct log submission
  http {
    port => 8080
    codec => json
  }
}

filter {
  # Add timestamp if not present
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }
  
  # Parse JSON in message field if it exists
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }
  
  # Add service information if not present
  if ![service] {
    mutate {
      add_field => { "service" => "unknown" }
    }
  }
  
  # Add host information
  if ![host] {
    mutate {
      add_field => { "host" => "%{[hostname]}" }
    }
  }
  
  # Add environment information if not present
  if ![environment] {
    mutate {
      add_field => { "environment" => "${ENVIRONMENT:development}" }
    }
  }
  
  # Enrich logs with trace context if available
  if [traceId] {
    mutate {
      add_field => { "trace_id" => "%{[traceId]}" }
    }
  }
  
  # Process specific error logs
  if [level] == "error" or [level] == "ERROR" {
    mutate {
      add_tag => ["error"]
    }
  }
  
  # Create daily log indices
  mutate {
    add_field => { "[@metadata][index_suffix]" => "%{+YYYY.MM.dd}" }
  }
}

output {
  # Send all logs to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logs-%{service}-%{[@metadata][index_suffix]}"
    template_name => "noderr"
    manage_template => true
    template => "/usr/share/logstash/config/templates/noderr-template.json"
    template_overwrite => true
  }
  
  # Send error logs to dedicated index
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "errors-%{[@metadata][index_suffix]}"
    }
  }
  
  # Optional debug output (disabled in production)
  if [environment] != "production" {
    stdout {
      codec => rubydebug
    }
  }
} 