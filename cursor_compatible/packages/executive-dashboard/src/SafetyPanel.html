<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noderr Safety Control Panel</title>
    <style>
        /* Safety Panel Styles */
        .safety-panel {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            max-width: 1200px;
            margin: 0 auto;
        }

        .safety-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #333;
        }

        .safety-title {
            font-size: 28px;
            font-weight: bold;
            color: #00e5ff;
        }

        .emergency-stop-btn {
            background-color: #ff1744;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(255, 23, 68, 0.3);
        }

        .emergency-stop-btn:hover {
            background-color: #d50000;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 23, 68, 0.5);
        }

        /* Trading Mode Section */
        .mode-section {
            background-color: #1a1a1a;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .mode-indicator {
            display: inline-block;
            padding: 15px 30px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 10px;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .mode-simulation {
            background-color: #2196f3;
            color: white;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .mode-paused {
            background-color: #ff9800;
            color: white;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }

        .mode-live {
            background-color: #4caf50;
            color: white;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(76, 175, 80, 0.8); }
            100% { box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4); }
        }

        .mode-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .mode-btn.simulation {
            background-color: #1976d2;
            color: white;
        }

        .mode-btn.paused {
            background-color: #f57c00;
            color: white;
        }

        .mode-btn.live {
            background-color: #388e3c;
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .mode-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Capital Allocation View */
        .capital-section {
            background-color: #1a1a1a;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .capital-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .capital-card {
            background-color: #252525;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #00e5ff;
        }

        .capital-card h4 {
            margin: 0 0 10px 0;
            color: #888;
            font-size: 14px;
            text-transform: uppercase;
        }

        .capital-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #00e5ff;
        }

        /* Agent Allocations Table */
        .agent-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .agent-table th {
            background-color: #252525;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #00e5ff;
            border-bottom: 2px solid #333;
        }

        .agent-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #333;
        }

        .agent-table tr:hover {
            background-color: #202020;
        }

        .status-active {
            color: #4caf50;
            font-weight: 600;
        }

        .status-frozen {
            color: #ff9800;
            font-weight: 600;
        }

        .status-draining {
            color: #2196f3;
            font-weight: 600;
        }

        .status-decommissioned {
            color: #666;
            font-style: italic;
        }

        .positive {
            color: #4caf50;
        }

        .negative {
            color: #ff5252;
        }

        .decommission-btn {
            background-color: #ff5252;
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .decommission-btn:hover {
            background-color: #d32f2f;
        }

        /* Reactivation Criteria */
        .reactivation-section {
            background-color: #1a1a1a;
            padding: 25px;
            border-radius: 10px;
        }

        .criteria-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .criteria-item {
            padding: 15px;
            margin-bottom: 10px;
            background-color: #252525;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .criteria-item.passed {
            border-left: 4px solid #4caf50;
        }

        .criteria-item.pending {
            border-left: 4px solid #ff9800;
        }

        .criteria-icon {
            font-size: 20px;
            margin-right: 15px;
        }

        .criteria-details {
            flex-grow: 1;
        }

        .criteria-value {
            font-weight: bold;
            color: #00e5ff;
        }

        /* WebSocket Status */
        .ws-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ws-connected {
            background-color: #4caf50;
            color: white;
        }

        .ws-disconnected {
            background-color: #ff5252;
            color: white;
        }

        .ws-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="safety-panel">
        <!-- Header -->
        <div class="safety-header">
            <h1 class="safety-title">üîê Safety Control Center</h1>
            <button class="emergency-stop-btn" onclick="emergencyStop()">
                üö® EMERGENCY STOP
            </button>
        </div>

        <!-- Trading Mode Control -->
        <div class="mode-section">
            <h2>Trading Mode</h2>
            <div id="mode-indicator" class="mode-indicator mode-simulation">
                SIMULATION
            </div>
            <div class="mode-buttons">
                <button class="mode-btn simulation" onclick="setMode('SIMULATION')">
                    Simulation
                </button>
                <button class="mode-btn paused" onclick="setMode('PAUSED')">
                    Pause
                </button>
                <button class="mode-btn live" onclick="setMode('LIVE')">
                    Go Live
                </button>
            </div>
            <div id="mode-info" style="margin-top: 15px; color: #888;">
                Last change: Never | Reason: Initial state
            </div>
        </div>

        <!-- Capital Allocation View -->
        <div class="capital-section">
            <h2>Capital Allocation</h2>
            <div class="capital-summary">
                <div class="capital-card">
                    <h4>Total Capital</h4>
                    <div class="value" id="total-capital">$0</div>
                </div>
                <div class="capital-card">
                    <h4>Reserve Capital</h4>
                    <div class="value" id="reserve-capital">$0</div>
                </div>
                <div class="capital-card">
                    <h4>Allocated Capital</h4>
                    <div class="value" id="allocated-capital">$0</div>
                </div>
                <div class="capital-card">
                    <h4>Active Agents</h4>
                    <div class="value" id="active-agents">0</div>
                </div>
            </div>

            <h3>Agent Allocations</h3>
            <table class="agent-table">
                <thead>
                    <tr>
                        <th>Agent ID</th>
                        <th>Strategy</th>
                        <th>Allocated</th>
                        <th>Available</th>
                        <th>Locked</th>
                        <th>P&L</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="agent-table-body">
                    <!-- Agents will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Reactivation Criteria -->
        <div class="reactivation-section" id="reactivation-section">
            <h2>Live Trading Reactivation Criteria</h2>
            <ul class="criteria-list">
                <li class="criteria-item pending" id="criteria-backtest">
                    <div style="display: flex; align-items: center;">
                        <span class="criteria-icon" id="icon-backtest">‚è≥</span>
                        <div class="criteria-details">
                            <strong>Backtest Validation</strong>
                            <div>All historical scenarios must pass</div>
                        </div>
                    </div>
                    <span class="criteria-value" id="value-backtest">Not Started</span>
                </li>
                <li class="criteria-item pending" id="criteria-sharpe">
                    <div style="display: flex; align-items: center;">
                        <span class="criteria-icon" id="icon-sharpe">‚è≥</span>
                        <div class="criteria-details">
                            <strong>Paper Trading Sharpe Ratio</strong>
                            <div>Must achieve ‚â• 2.0</div>
                        </div>
                    </div>
                    <span class="criteria-value" id="value-sharpe">0.00</span>
                </li>
                <li class="criteria-item pending" id="criteria-days">
                    <div style="display: flex; align-items: center;">
                        <span class="criteria-icon" id="icon-days">‚è≥</span>
                        <div class="criteria-details">
                            <strong>Paper Trading Duration</strong>
                            <div>Minimum 30 days required</div>
                        </div>
                    </div>
                    <span class="criteria-value" id="value-days">0 days</span>
                </li>
                <li class="criteria-item pending" id="criteria-chaos">
                    <div style="display: flex; align-items: center;">
                        <span class="criteria-icon" id="icon-chaos">‚è≥</span>
                        <div class="criteria-details">
                            <strong>Chaos Tests</strong>
                            <div>All resilience scenarios must pass</div>
                        </div>
                    </div>
                    <span class="criteria-value" id="value-chaos">Not Started</span>
                </li>
                <li class="criteria-item pending" id="criteria-manual">
                    <div style="display: flex; align-items: center;">
                        <span class="criteria-icon" id="icon-manual">‚è≥</span>
                        <div class="criteria-details">
                            <strong>Manual Approval</strong>
                            <div>Authorized operator must approve</div>
                        </div>
                    </div>
                    <span class="criteria-value" id="value-manual">Not Approved</span>
                </li>
            </ul>
            <div style="text-align: center; margin-top: 20px;">
                <button class="mode-btn live" onclick="requestReactivation()" style="width: auto; padding: 12px 30px;">
                    Request Live Trading Reactivation
                </button>
            </div>
        </div>
    </div>

    <!-- WebSocket Status Indicator -->
    <div id="ws-status" class="ws-status ws-disconnected">
        <span class="ws-dot"></span>
        <span>Disconnected</span>
    </div>

    <script>
        // WebSocket connection
        let ws = null;
        let reconnectInterval = null;
        let currentMode = 'SIMULATION';
        
        // Initialize WebSocket connection
        function connectWebSocket() {
            const wsUrl = 'ws://localhost:3001/safety';
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('WebSocket connected');
                    updateWSStatus(true);
                    
                    // Request current state
                    ws.send(JSON.stringify({ type: 'get-status' }));
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateWSStatus(false);
                };
                
                ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    updateWSStatus(false);
                    
                    // Attempt to reconnect
                    if (!reconnectInterval) {
                        reconnectInterval = setInterval(() => {
                            console.log('Attempting to reconnect...');
                            connectWebSocket();
                        }, 5000);
                    }
                };
                
            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
                updateWSStatus(false);
            }
        }
        
        // Update WebSocket status indicator
        function updateWSStatus(connected) {
            const statusEl = document.getElementById('ws-status');
            if (connected) {
                statusEl.className = 'ws-status ws-connected';
                statusEl.innerHTML = '<span class="ws-dot"></span><span>Connected</span>';
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            } else {
                statusEl.className = 'ws-status ws-disconnected';
                statusEl.innerHTML = '<span class="ws-dot"></span><span>Disconnected</span>';
            }
        }
        
        // Handle incoming WebSocket messages
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'mode-changed':
                    updateTradingMode(data.mode, data.lastChange);
                    break;
                case 'capital-update':
                    updateCapitalView(data.capital);
                    break;
                case 'reactivation-criteria':
                    updateReactivationCriteria(data.criteria);
                    break;
                case 'agent-update':
                    updateAgentTable(data.agents);
                    break;
                case 'emergency-stop':
                    handleEmergencyStopEvent(data);
                    break;
            }
        }
        
        // Update trading mode display
        function updateTradingMode(mode, lastChange) {
            currentMode = mode;
            const indicator = document.getElementById('mode-indicator');
            const info = document.getElementById('mode-info');
            
            // Update indicator
            indicator.className = `mode-indicator mode-${mode.toLowerCase()}`;
            indicator.textContent = mode;
            
            // Update buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.disabled = btn.classList.contains(mode.toLowerCase());
            });
            
            // Update info
            if (lastChange) {
                const date = new Date(lastChange.timestamp);
                info.innerHTML = `Last change: ${date.toLocaleString()} | Reason: ${lastChange.reason} | By: ${lastChange.authorizedBy || 'System'}`;
            }
            
            // Show/hide reactivation section
            document.getElementById('reactivation-section').style.display = 
                mode === 'LIVE' ? 'none' : 'block';
        }
        
        // Update capital allocation view
        function updateCapitalView(capital) {
            document.getElementById('total-capital').textContent = 
                `$${capital.totalCapital.toLocaleString()}`;
            document.getElementById('reserve-capital').textContent = 
                `$${capital.reserveCapital.toLocaleString()}`;
            document.getElementById('allocated-capital').textContent = 
                `$${capital.allocatedCapital.toLocaleString()}`;
            document.getElementById('active-agents').textContent = 
                capital.activeAgentCount;
            
            // Update agent table
            if (capital.agentAllocations) {
                updateAgentTable(capital.agentAllocations);
            }
        }
        
        // Update agent allocations table
        function updateAgentTable(agents) {
            const tbody = document.getElementById('agent-table-body');
            tbody.innerHTML = '';
            
            agents.forEach(agent => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${agent.agentId}</td>
                    <td>${agent.strategyId}</td>
                    <td>$${agent.allocated.toLocaleString()}</td>
                    <td>$${agent.available.toLocaleString()}</td>
                    <td>$${agent.locked.toLocaleString()}</td>
                    <td class="${agent.performance >= 0 ? 'positive' : 'negative'}">
                        $${agent.performance.toFixed(2)}
                    </td>
                    <td class="status-${agent.status.toLowerCase()}">${agent.status}</td>
                    <td>
                        ${agent.status === 'ACTIVE' ? 
                            `<button class="decommission-btn" onclick="decommissionAgent('${agent.agentId}')">
                                Decommission
                            </button>` : '-'
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Update reactivation criteria
        function updateReactivationCriteria(criteria) {
            // Backtest
            updateCriteriaItem('backtest', criteria.backtestPassed, 
                criteria.backtestPassed ? 'Passed' : 'Not Started');
            
            // Sharpe ratio
            const sharpeOk = criteria.paperTradingSharpe >= 2.0;
            updateCriteriaItem('sharpe', sharpeOk, 
                criteria.paperTradingSharpe.toFixed(2));
            
            // Trading days
            const daysOk = criteria.paperTradingDays >= 30;
            updateCriteriaItem('days', daysOk, 
                `${criteria.paperTradingDays} days`);
            
            // Chaos tests
            updateCriteriaItem('chaos', criteria.chaosTestsPassed, 
                criteria.chaosTestsPassed ? 'Passed' : 'Not Started');
            
            // Manual approval
            updateCriteriaItem('manual', criteria.manualApproval?.approved, 
                criteria.manualApproval?.approved ? 
                    `Approved by ${criteria.manualApproval.approvedBy}` : 'Not Approved');
        }
        
        // Update individual criteria item
        function updateCriteriaItem(id, passed, value) {
            const item = document.getElementById(`criteria-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            const valueEl = document.getElementById(`value-${id}`);
            
            item.className = `criteria-item ${passed ? 'passed' : 'pending'}`;
            icon.textContent = passed ? '‚úÖ' : '‚è≥';
            valueEl.textContent = value;
        }
        
        // Control functions
        function setMode(mode) {
            if (mode === currentMode) return;
            
            const reason = prompt(`Why are you changing to ${mode} mode?`);
            if (!reason) return;
            
            if (mode === 'LIVE') {
                if (!confirm('‚ö†Ô∏è WARNING: You are about to enable LIVE TRADING with real money. Are you absolutely sure?')) {
                    return;
                }
            }
            
            // Send mode change request
            fetch('/api/safety/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mode,
                    reason,
                    authorizedBy: 'Dashboard User'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert(`Failed to change mode: ${data.error}`);
                }
            })
            .catch(error => {
                alert(`Error changing mode: ${error.message}`);
            });
        }
        
        function emergencyStop() {
            if (!confirm('üö® EMERGENCY STOP will halt ALL trading activity immediately. Continue?')) {
                return;
            }
            
            const reason = prompt('Reason for emergency stop:') || 'Manual emergency stop';
            
            fetch('/api/safety/emergency-stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason })
            })
            .then(response => response.json())
            .then(data => {
                alert('üö® EMERGENCY STOP ACTIVATED');
            })
            .catch(error => {
                alert(`Error triggering emergency stop: ${error.message}`);
            });
        }
        
        function decommissionAgent(agentId) {
            if (!confirm(`Decommission agent ${agentId}? This will recall all capital and close positions.`)) {
                return;
            }
            
            const strategy = prompt('Liquidation strategy (IMMEDIATE/GRADUAL/OPTIMAL/TRANSFER):', 'OPTIMAL');
            if (!strategy) return;
            
            fetch(`/api/capital/agents/${agentId}/decommission`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reason: 'Manual decommission',
                    liquidationStrategy: strategy.toUpperCase()
                })
            })
            .then(response => response.json())
            .then(data => {
                alert(`Agent decommissioned. Recalled capital: $${data.recalledCapital.toFixed(2)}`);
            })
            .catch(error => {
                alert(`Error decommissioning agent: ${error.message}`);
            });
        }
        
        function requestReactivation() {
            if (!confirm('Request live trading reactivation? All criteria must be met.')) {
                return;
            }
            
            const notes = prompt('Any notes for the reactivation request?');
            
            fetch('/api/safety/reactivation/request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    requestedBy: 'Dashboard User',
                    notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Live trading reactivated successfully!');
                } else {
                    alert(`‚ùå Reactivation failed: ${data.reason}`);
                }
            })
            .catch(error => {
                alert(`Error requesting reactivation: ${error.message}`);
            });
        }
        
        function handleEmergencyStopEvent(data) {
            // Flash the screen red
            document.body.style.backgroundColor = '#ff0000';
            setTimeout(() => {
                document.body.style.backgroundColor = '';
            }, 500);
            
            // Show alert
            alert(`üö® EMERGENCY STOP: ${data.reason}`);
        }
        
        // Initialize on page load
        window.onload = () => {
            // Connect WebSocket
            connectWebSocket();
            
            // Load initial data (fallback if WebSocket fails)
            setTimeout(() => {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    loadInitialData();
                }
            }, 2000);
        };
        
        // Load initial data via REST API
        function loadInitialData() {
            // This would fetch initial state from REST endpoints
            console.log('Loading initial data via REST API...');
            
            // Example: fetch current safety status
            fetch('/api/safety/status')
                .then(response => response.json())
                .then(data => {
                    updateTradingMode(data.mode, data.lastChange);
                })
                .catch(error => console.error('Failed to load safety status:', error));
        }
    </script>
</body>
</html> 